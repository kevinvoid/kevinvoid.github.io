---
layout: post
title:  "抓包工具Charles使用说明"
date:   2020-06-09 17:34:02 +0800
categories: 字符集、字符集编码
---

### 前言
自从用了mac之后,抓包工具: wiresharks就没有用,需要寻找一个替代品,就用了charles来完成抓包工作.本文所述是在mac下完成

### 安装
- charles官网: [https://www.charlesproxy.com/latest-release/download.do](https://www.charlesproxy.com/latest-release/download.do)
- 查找适合自己电脑版本的charles安装,本文所使用的是mac版charles-4.5.4版本

### charles主界面
- charles主界面主要分图中的两块,一部分是左上角的菜单下拉项;一部分是快捷工具按钮栏(包含于菜单下拉项),快捷常用按钮能满足大部分的使用
![charles主界面](https://raw.githubusercontent.com/kevinvoid/blog-image-repo/master/2020/charles-05-1.png)

- 常用工具栏
![charles常用工具栏](https://raw.githubusercontent.com/kevinvoid/blog-image-repo/master/2020/charles-04-1.png)
	- 按钮依次说明
		- 清除捕获到的所有请求
		- 红点状态说明正在捕获请求，灰色状态说明目前没有捕获请求。(**启动抓取/停止抓取**)
		- 灰色状态说明是没有开启网速节流，绿色状态说明开启了网速节流。
		- 灰色状态说明是没有开启断点，红色状态说明开启了断点。
		- 编辑修改请求，点击之后可以修改请求的内容。
		- 重复发送请求，点击之后选中的请求会被再次发送。
		- 验证选中的请求的响应。
		- 常用功能，包含了 Tools 菜单中的常用功能。
		- 常用设置，包含了 Proxy 菜单中的常用设置。

- 主界面试图
	- Structure： 此视图将网络请求按访问的域名分类。
	- Sequence： 此视图将网络请求按访问的时间排序。


### 案例
- **拦截所有请求**
	- 主界面设置Enable macOS proxy. 
		- 步骤: Proxy --> Proxy Settings --> macOS面板栏 --> 勾选Enable macOS proxy
	![charles](https://raw.githubusercontent.com/kevinvoid/blog-image-repo/master/2020/charles-01-1.png)
	![charles enabled macOS proxy](https://raw.githubusercontent.com/kevinvoid/blog-image-repo/master/2020/charles-01-2.jpg)
	- 启动: Proxy -> Start Recording 或者使用Charles常用工具栏的启动抓取按钮
	- 结果:
	![charles](https://raw.githubusercontent.com/kevinvoid/blog-image-repo/master/2020/charles-01-3.png)

- **拦截指定的请求**: 使用recording settings
	- 设置recording setting: Proxy --> Recording Settings
	- 设置拦截https://www.baidu.com 和http://172.16.1.122 (172.16.1.122是本机ip地址,拦截本机服务不要使用localhost或者127.0.0.1,这样charles代理就没有效果,抓取不到)
	![charles recoding settings](https://raw.githubusercontent.com/kevinvoid/blog-image-repo/master/2020/charles-02-3.png)
	![charles recoding settings](https://raw.githubusercontent.com/kevinvoid/blog-image-repo/master/2020/charles-02-4.png)
	- 运行
	- 拦截结果:
	![charles recoding settings](https://raw.githubusercontent.com/kevinvoid/blog-image-repo/master/2020/charles-02-5.png)
	![charles recoding settings](https://raw.githubusercontent.com/kevinvoid/blog-image-repo/master/2020/charles-02-6.png)

- **拦截https,并查看明文内容**
	- 设置SSL Proxying Settings, Proxy --> SSL Proxying Settings
	- 查看172.16.1.122的https的明文内容设置
	![charles SSL Proxying Settings](https://raw.githubusercontent.com/kevinvoid/blog-image-repo/master/2020/charles-06-1.png)
	- 查看设置结果  
	设置之前
	![charles设置SSL Proxying Settings之前加密的密文](https://raw.githubusercontent.com/kevinvoid/blog-image-repo/master/2020/charles-06-2.png)  
	设置之后
	![ccharles设置SSL Proxying Settings之后看到的明文](https://raw.githubusercontent.com/kevinvoid/blog-image-repo/master/2020/charles-06-3.png)


### 抓包分析
- 对抓包的结果查看,分析http请求(后期得空再完成吧)

### charles或者抓包工具的原理



### 注意
- 抓取https失败,出现certificate_unknown (46) - An unknown issue occurred processing the certificate的提示,需添加charles证书到mac钥匙串,并设置成始终信任. Help --> SSL Proxying --> Install Charles  Root Certificate
- 使用charles如果不工作,可能原因之一本机开了Shadowsocks或者其他外网代理访问工具
- 使用Recording Settings抓取本地服务设置成localhost或者127.0.0.1抓取不到的原因,多半跟charles的实现原理有关,网络没有转发,抓取不到

### 思考
- 写图文博客有点麻烦,要截图上传到github个人的图片服务器,再获取图片地址
- 要清楚charles的实现原理,不然差错很困难,例如开了Shadowsocks代理工具就一直抓取不到;127.0.0.1也不抓取不到
- 抓包的原理

### 参考资料
[Charles 功能介绍和使用教程](https://juejin.im/post/5b8350b96fb9a019d9246c4c)   

